title Quansentz Architecture
// Quansentz MVP — Consent + DSAR + Retention + Audit (Multi-tenant)

// Global layout + styling
direction right
typeface clean
styleMode plain
colorMode pastel

// =========================
// (1) Clients & Tenant Systems
// =========================
Clients [color: "#2b6cb0"] {
  EndUserBrowser [label: "End User Browser", icon: monitor]
  AdminBrowser [label: "Tenant Admin Browser", icon: user]
  TenantWebApp [label: "Tenant Website / Web App", icon: globe]
  QuansentzSDK [label: "Quansentz Web SDK (banner + APIs)", icon: code]
  ThirdPartyScripts [label: "3rd-Party Scripts (analytics/ads)", icon: activity]
  TenantWebhookEndpoint [label: "Tenant Webhook Endpoint", icon: server]
}

// =========================
// (2) Edge / Entry
// =========================
Edge [color: "#3182ce"] {
  DNS_CDN [label: "DNS / CDN / TLS Termination", icon: cloud]
  TenantRouter [label: "Tenant Resolution (domain → tenantId)", icon: link]
  RateLimit [label: "Rate Limiter (DSAR + Admin)", icon: shield]
}

// =========================
// (3) Quansentz Core (App + APIs + Worker)
// =========================
Quansentz [color: "#6b46c1"] {

  WebApp [label: "Quansentz Web App (Next.js)", icon: vercel] {
    PublicUI [label: "Public UI:Consent + DSAR Portal", icon: azure-management-portal]
    AdminUI [label: "Admin UI:Dashboard + DSAR Ops", icon: layout]
    APIRoutes [label: "HTTP APIs (/api/*)", icon: api]
  }

  Worker [label: "Background Worker (Queue Consumers)", icon: cpu] {
    DSAR_ExportJob [label: "DSAR Export Job (ZIP + store)", icon: archive]
    DSAR_DeleteJob [label: "DSAR Delete Job (retention-aware)", icon: trash-2]
    RetentionJob [label: "Retention Runner (scheduled)", icon: clock]
    WebhookJob [label: "Webhook Delivery (retries + HMAC)", icon: send]
  }

  Evidence [label: "Evidence Engine", icon: file-text] {
    AuditChain [label: "Tamper-evident Audit Chain (hash + prevHash)", icon: hash]
    PolicyVersioning [label: "Policy + Purpose Versioning", icon: file]
  }
}

// =========================
// (4) Data Stores + External Providers
// =========================
DataStores [color: "#2f855a"] {
  PostgresDB [label: "Postgres (tenant-scoped data)", icon: database]
  RedisQueue [label: "Redis (queues + rate limits)", icon: database]
  ObjectStorage [label: "Object Storage (DSAR exports)", icon: aws-s3]
}

External [color: "#4a5568"] {
  EmailProvider [label: "Email Provider (SMTP/Transactional)", icon: mail]
  Observability [label: "Logs / Metrics / Traces", icon: bar-chart-2]
}

// =========================
// Connections (sync = solid, async = dotted)
// =========================

// Tenant site embeds SDK + banner

// Entry + tenant resolution

// Public flows

// Admin flows

// Core persistence + evidence

// Queueing + workers

// DSAR Export pipeline

// DSAR Delete pipeline (retention-aware)

// Retention

// Webhooks (HMAC signed + retries)

// Observability
TenantWebApp > QuansentzSDK: "embed script" [color: blue]
EndUserBrowser > TenantWebApp: "browse tenant site" [color: blue]
QuansentzSDK > ThirdPartyScripts: "allow/block by consent" [color: blue]
EndUserBrowser > DNS_CDN: "https" [color: blue]
AdminBrowser > DNS_CDN: "https" [color: purple]
DNS_CDN > TenantRouter: "host header" [color: blue]
TenantRouter > WebApp: "tenant context (tenantId)" [color: blue]
QuansentzSDK > APIRoutes: "GET/POST consent, DSAR intake" [color: blue]
PublicUI > APIRoutes: "DSAR request + status" [color: blue]
APIRoutes > RateLimit: "check limits" [color: orange]
RateLimit > RedisQueue: "counters" [color: orange]
AdminUI > APIRoutes: "admin actions" [color: purple]
APIRoutes > EmailProvider: "magic link / verify emails" [color: purple]
APIRoutes > PostgresDB: "tenant-scoped writes/reads" [color: green]
APIRoutes > AuditChain: "append audit events" [color: green]
AuditChain > PostgresDB: "store events + chain" [color: green]
PolicyVersioning > PostgresDB: "purposes + policy versions" [color: green]
APIRoutes --> RedisQueue: "enqueue jobs" [color: orange]
RedisQueue --> Worker: "consume jobs" [color: orange]
DSAR_ExportJob > PostgresDB: "update DSAR status" [color: orange]
DSAR_ExportJob > ObjectStorage: "write export ZIP" [color: orange]
DSAR_ExportJob > EmailProvider: "export ready + signed link" [color: orange]
ObjectStorage > APIRoutes: "signed URL generation" [color: green]
DSAR_DeleteJob > PostgresDB: "mark/delete per rules" [color: orange]
DSAR_DeleteJob > AuditChain: "log delete evidence" [color: orange]
RetentionJob > PostgresDB: "apply retention rules" [color: orange]
RetentionJob > AuditChain: "log retention run" [color: orange]
WebhookJob > TenantWebhookEndpoint: "POST webhook (HMAC)" [color: orange]
WebhookJob > PostgresDB: "store delivery attempts" [color: orange]
WebhookJob > AuditChain: "log webhook evidence" [color: orange]
WebApp > Observability: "request logs + metrics" [color: gray]
Worker > Observability: "job logs + metrics" [color: gray]
